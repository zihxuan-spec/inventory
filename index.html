<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMS</title>
    
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/354a5f/ffffff.png?text=WMS&font=roboto">
    <link rel="icon" href="https://placehold.co/192x192/354a5f/ffffff.png?text=WMS&font=roboto">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- SAP Fiori Style Theme --- */
        :root {
            --sap-shell-color: #354a5f; --sap-bg-color: #edf0f4; --sap-surface-color: #ffffff;
            --sap-text-color: #32363a; --sap-border-color: #d9d9d9;
            --sap-primary: #0a6ed1; --sap-success: #107e3e; --sap-critical: #bb0000; --sap-warning: #e9730c;
            --sap-font-family: "72", "Arial", "Helvetica", sans-serif;
        }
        body { margin: 0; padding: 0; font-family: var(--sap-font-family); background-color: var(--sap-bg-color); color: var(--sap-text-color); font-size: 0.875rem; line-height: 1.4; }
        
        .shell-bar { background-color: var(--sap-shell-color); height: 44px; display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; color: white; box-shadow: 0 4px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .shell-logo { font-weight: bold; font-size: 1rem; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;}
        
        .page-header { background-color: var(--sap-surface-color); padding: 1rem 2rem; border-bottom: 1px solid var(--sap-border-color); display: flex; justify-content: space-between; align-items: center; }
        .content-area { padding: 1rem 2rem; max-width: 100%; box-sizing: border-box; }
        
        .nav-tabs { display: flex; gap: 20px; }
        .nav-item { cursor: pointer; padding-bottom: 5px; color: #6a6d70; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .nav-item:hover { color: var(--sap-primary); }
        .nav-item.active { color: var(--sap-primary); border-bottom-color: var(--sap-primary); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--sap-border-color); }
        .card-title { font-size: 13px; color: #666; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; }
        .card-value { font-size: 36px; font-weight: normal; color: var(--sap-text-color); }
        .card-sub { font-size: 12px; color: #888; margin-top: 5px; }
        .card.alert { border-left: 5px solid var(--sap-critical); }
        .card.warn { border-left: 5px solid var(--sap-warning); }
        .card.safe { border-left: 5px solid var(--sap-success); }
        .card.info { border-left: 5px solid var(--sap-primary); }

        .table-container { background: var(--sap-surface-color); border: 1px solid var(--sap-border-color); border-radius: 4px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-top: 1rem; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; table-layout: fixed; min-width: 1000px; }
        thead { background-color: #f7f7f7; border-bottom: 1px solid var(--sap-border-color); }
        th { padding: 10px 16px; font-weight: normal; color: #6a6d70; font-size: 12px; text-transform: uppercase; }
        td { padding: 10px 16px; border-bottom: 1px solid #eeeeee; vertical-align: middle; color: var(--sap-text-color); }
        tr:hover { background-color: #ebf5fe; cursor: pointer; }

        .col-status { width: 35px; text-align: center; padding: 0 !important; }
        .col-pn { width: 120px; font-weight: bold; color: var(--sap-primary); }
        th.col-pn, td.col-pn { padding-left: 12px !important; }
        .col-model { width: 220px; white-space: normal; word-wrap: break-word; line-height: 1.3; }
        .col-desc { width: auto; white-space: normal; word-wrap: break-word; line-height: 1.3; } 
        .col-unit { width: 60px; font-size: 12px; text-align: center; }
        .col-action { width: 120px; text-align: center; white-space: nowrap; }
        .col-loc { width: 80px; text-align: center; color: #555; }
        .col-stock { width: 90px; text-align: center; font-size: 12px; }
        .col-loc span { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 11px; }

        /* Âà™Èô§ÊåâÈàïÊ®£Âºè */
        .btn-delete { color: #bb0000; font-weight: bold; cursor: pointer; padding: 4px 8px; border-radius: 4px; border: 1px solid transparent; margin-left: 5px; font-size: 12px; }
        .btn-delete:hover { background-color: #ffe6e6; border-color: #bb0000; }

        .toolbar { padding: 10px 0; display: flex; gap: 10px; align-items: center; flex-wrap: nowrap; width: 100%; }
        .spacer { flex-grow: 1; }
        .std-input { height: 36px; padding: 0 10px; border: 1px solid #89919a; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; background-color: white; }
        .std-btn { height: 36px; padding: 0 16px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; border: 1px solid transparent; white-space: nowrap; }
        .btn-po { background-color: var(--sap-primary); color: white; }
        .btn-issue { background-color: var(--sap-critical); color: white; }
        .btn-excel { background-color: #107e3e; color: white; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .std-dialog { background: white; width: 500px; border-radius: 6px; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 0 20px rgba(0,0,0,0.15); border: 1px solid var(--sap-border-color); }
        .dialog-header { padding: 10px 20px; border-bottom: 1px solid var(--sap-border-color); display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: bold; }
        .dialog-content { padding: 20px; overflow-y: auto; }
        .dialog-footer { padding: 10px 20px; border-top: 1px solid var(--sap-border-color); display: flex; justify-content: flex-end; gap: 10px; }
        
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #32363a; color: white; padding: 10px 20px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; z-index: 2000; pointer-events: none; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: #0a6ed1; z-index: 2001; display: none; }
    </style>
</head>
<body>
    <div id="loading"></div>
    <div class="shell-bar">
        <div class="shell-logo">üì¶ WMS Inventory System</div>
        <div class="nav-tabs">
            <div class="nav-item active" onclick="showTab('inv', this)" data-i18n="nav_inv">Inventory</div>
            <div class="nav-item" onclick="showTab('master', this)" data-i18n="nav_master">Master Data</div>
        </div>
        <button class="std-btn" style="background:transparent; color:white; border:1px solid white;" onclick="toggleLanguage()">EN/‰∏≠</button>
    </div>

    <div id="view-inv" class="content-area">
        <div class="dashboard-grid" id="dashboard"></div>
        <div class="toolbar">
            <input type="text" id="searchInv" class="std-input" style="width: 300px;" placeholder="Search PN, Model, Desc..." oninput="renderTable()">
            <div class="spacer"></div>
            <button class="std-btn btn-po" onclick="openTx('receive')">Ôºã <span data-i18n="btn_receive">Receive</span></button>
            <button class="std-btn btn-issue" onclick="openTx('issue')">Ôºç <span data-i18n="btn_issue">Issue</span></button>
            <button class="std-btn btn-excel" onclick="exportToExcel()">Excel</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="col-status"></th>
                        <th class="col-pn" data-i18n="th_pn">Part Number</th>
                        <th class="col-model" data-i18n="th_model">Model</th>
                        <th class="col-desc" data-i18n="th_desc">Description</th>
                        <th class="col-loc" data-i18n="th_loc">Location</th>
                        <th class="col-stock" data-i18n="th_stock">Stock</th>
                        <th class="col-unit" data-i18n="th_unit">Unit</th>
                    </tr>
                </thead>
                <tbody id="invBody"></tbody>
            </table>
        </div>
    </div>

    <div id="view-master" class="content-area" style="display:none;">
        <div class="toolbar">
            <input type="text" id="searchMaster" class="std-input" style="width: 300px;" placeholder="Search Master..." oninput="renderMasterTable()">
            <div class="spacer"></div>
            <button class="std-btn btn-po" onclick="openModal('createModal')">Ôºã <span data-i18n="btn_new_master">New Master</span></button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="col-pn" data-i18n="th_pn">Part Number</th>
                        <th class="col-model" data-i18n="th_model">Model</th>
                        <th class="col-desc" data-i18n="th_desc">Description</th>
                        <th class="col-unit" data-i18n="th_unit">Unit</th>
                        <th class="col-action" data-i18n="th_action">Action</th>
                    </tr>
                </thead>
                <tbody id="masterBody"></tbody>
            </table>
        </div>
    </div>

    <div id="txModal" class="modal-overlay">
        <div class="std-dialog" style="width: 700px;">
            <div class="dialog-header">
                <span id="txTitle">Transaction</span>
                <span style="cursor:pointer" onclick="closeModal('txModal')">‚úñ</span>
            </div>
            <div class="dialog-content">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div>
                        <label id="lblRef" style="display:block; font-size:12px; color: #666; margin-bottom:4px;">Reference</label>
                        <input type="text" id="txRef" class="std-input">
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; color: #666; margin-bottom:4px;" data-i18n="lbl_user">User</label>
                        <input type="text" id="txUser" class="std-input">
                    </div>
                </div>
                <div class="table-container" style="max-height: 300px; margin-top:0;">
                    <table style="min-width: 100%;">
                        <thead style="position:sticky; top:0; z-index:1;">
                            <tr>
                                <th style="width:150px;">Part Number</th>
                                <th id="thTxLoc" style="width:100px;">Location</th>
                                <th style="width:100px;">Qty</th>
                                <th style="width:40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="txBody"></tbody>
                    </table>
                </div>
                <button class="std-btn" style="margin-top:10px; width:100%; border:1px dashed #ccc;" onclick="addTxRow()">Ôºã Add Item</button>
            </div>
            <div class="dialog-footer">
                <button class="std-btn" onclick="closeModal('txModal')" data-i18n="btn_cancel">Cancel</button>
                <button class="std-btn btn-po" id="btnPost" onclick="submitTx()" data-i18n="btn_post">Post</button>
            </div>
        </div>
    </div>

    <div id="createModal" class="modal-overlay">
        <div class="std-dialog">
            <div class="dialog-header">New Master Data <span style="cursor:pointer" onclick="closeModal('createModal')">‚úñ</span></div>
            <div class="dialog-content">
                <div style="display:grid; gap:10px;">
                    <input type="text" id="newId" class="std-input" placeholder="Part Number (Required)">
                    <input type="text" id="newModel" class="std-input" placeholder="Model">
                    <input type="text" id="newDesc" class="std-input" placeholder="Description">
                    <input type="text" id="newUnit" class="std-input" placeholder="Unit (EA, SET...)">
                    <input type="number" id="newMinStock" class="std-input" placeholder="Safety Stock Level">
                </div>
            </div>
            <div class="dialog-footer">
                <button class="std-btn" onclick="closeModal('createModal')">Cancel</button>
                <button class="std-btn btn-po" onclick="createMaster()">Save</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="std-dialog" style="width: 800px;">
            <div class="dialog-header"><span id="detailTitle">Details</span> <span style="cursor:pointer" onclick="closeModal('detailModal')">‚úñ</span></div>
            <div class="dialog-content">
                <div id="detailInfo" style="margin-bottom:20px; padding:15px; background:#f8f9fa; border-radius:4px; display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
                <h4 style="margin: 0 0 10px 0; font-size:14px; color:#666;">TRANSACTION HISTORY</h4>
                <div class="table-container" style="max-height: 300px;">
                    <table style="min-width: 100%;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ref</th>
                                <th>Type</th>
                                <th style="text-align:right">Qty</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody id="detailHistory"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="msgModal" class="modal-overlay">
        <div class="std-dialog" style="width: 350px;">
            <div class="dialog-header"><span id="msgTitle">Message</span></div>
            <div class="dialog-content" id="msgContent" style="text-align:center; padding:30px 20px;"></div>
            <div class="dialog-footer">
                <button class="std-btn btn-primary" onclick="closeModal('msgModal')">OK</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby0U1K-qS38sJW6_PIYzL5MzO6wSBSjoqlkkoyA3IIfcFr33RRYIMzGp0MSyj4FDknW/exec"; // ‚¨ÖÔ∏è Ë®òÂæóË≤º‰∏äÊÇ®ÁöÑÁ∂≤ÂùÄ
        let inventory = [], master = [], history = [];
        let currentLang = 'en';
        let currentTxType = 'receive';

        const i18n = {
            en: {
                nav_inv: "Inventory", nav_master: "Master Data", th_pn: "Part Number", th_model: "Model", th_desc: "Description",
                th_loc: "Location", th_stock: "Stock", th_unit: "Unit", th_action: "Action", btn_receive: "Receive", btn_issue: "Issue",
                btn_new_master: "New Master", lbl_user: "User", btn_post: "Post", btn_cancel: "Cancel",
                confirm_post_title: "Post Confirmation", confirm_post_body: "Are you sure you want to post these transactions?"
            },
            zh: {
                nav_inv: "Â∫´Â≠òÂàóË°®", nav_master: "Áâ©Êñô‰∏ªÊ™î", th_pn: "ÊñôËôü", th_model: "ÂûãËôü", th_desc: "ÂìÅÂêçÊèèËø∞",
                th_loc: "ÂÑ≤‰Ωç", th_stock: "Â∫´Â≠òÈáè", th_unit: "ÂñÆ‰Ωç", th_action: "Êìç‰Ωú", btn_receive: "ÂÖ•Â∫´Êî∂Ë≤®", btn_issue: "È†òÊñôÂá∫Â∫´",
                btn_new_master: "Êñ∞Â¢û‰∏ªÊ™î", lbl_user: "Êìç‰Ωú‰∫∫Âì°", btn_post: "Á¢∫Ë™çÈÅéÂ∏≥", btn_cancel: "ÂèñÊ∂à",
                confirm_post_title: "ÈÅéÂ∏≥Á¢∫Ë™ç", confirm_post_body: "ÊÇ®Á¢∫ÂÆöË¶ÅÊèê‰∫§ÈÄô‰∫õÁï∞ÂãïË≥áÊñôÂóéÔºü"
            }
        };

        async function fetchData() {
            setLoading(true);
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                inventory = data.inventory;
                master = data.master;
                history = data.history;
                renderTable();
                renderMasterTable();
                renderDashboard();
            } catch (e) { showMsg("Error", "Failed to fetch data: " + e.message); }
            finally { setLoading(false); }
        }

        function renderTable() {
            const query = document.getElementById('searchInv').value.toLowerCase();
            const body = document.getElementById('invBody');
            body.innerHTML = '';
            
            inventory.filter(item => 
                item.id.toLowerCase().includes(query) || 
                item.model.toLowerCase().includes(query) || 
                item.description.toLowerCase().includes(query)
            ).forEach(item => {
                const status = item.stock <= 0 ? 'crit' : (item.stock <= item.minStock ? 'low' : 'ok');
                const tr = document.createElement('tr');
                tr.onclick = () => showDetails(item.id);
                tr.innerHTML = `
                    <td class="col-status"><span class="status-dot status-${status}"></span></td>
                    <td class="col-pn">${item.id}</td>
                    <td class="col-model">${item.model}</td>
                    <td class="col-desc">${item.description}</td>
                    <td class="col-loc"><span>${item.location || '-'}</span></td>
                    <td class="col-stock">${item.stock}</td>
                    <td class="col-unit">${item.unit}</td>
                `;
                body.appendChild(tr);
            });
        }

        function renderMasterTable() {
            const query = document.getElementById('searchMaster').value.toLowerCase();
            const body = document.getElementById('masterBody');
            body.innerHTML = '';
            
            master.filter(item => 
                item.id.toLowerCase().includes(query) || 
                item.model.toLowerCase().includes(query) || 
                item.description.toLowerCase().includes(query)
            ).forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-pn">${item.id}</td>
                    <td class="col-model">${item.model}</td>
                    <td class="col-desc">${item.description}</td>
                    <td class="col-unit">${item.unit}</td>
                    <td class="col-action" id="act-${item.id.replace(/\s+/g, '')}"></td>
                `;
                body.appendChild(tr);
                
                const actionsTd = document.getElementById(`act-${item.id.replace(/\s+/g, '')}`);
                const btn = document.createElement('span');
                btn.style.color = 'var(--sap-primary)';
                btn.style.cursor = 'pointer';
                btn.innerText = 'Display';
                btn.onclick = () => showDetails(item.id);
                actionsTd.appendChild(btn);

                // Âä†ÂÖ•Âà™Èô§ÊåâÈàï
                const delBtn = document.createElement('span');
                delBtn.className = 'btn-delete';
                delBtn.innerText = 'Delete';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm(currentLang === 'zh' ? 'Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Áâ©Êñô‰∏ªÊ™îÂóéÔºü' : 'Delete this master data?')) {
                        deleteMaster(item.id);
                    }
                };
                actionsTd.appendChild(delBtn);
            });
        }

        function renderDashboard() {
            const container = document.getElementById('dashboard');
            const critical = inventory.filter(i => i.stock <= 0).length;
            const low = inventory.filter(i => i.stock > 0 && i.stock <= i.minStock).length;
            
            container.innerHTML = `
                <div class="card alert"><div class="card-title">Out of Stock</div><div class="card-value">${critical}</div><div class="card-sub">Items need immediate refill</div></div>
                <div class="card warn"><div class="card-title">Low Stock</div><div class="card-value">${low}</div><div class="card-sub">Items below safety level</div></div>
                <div class="card info"><div class="card-title">Total Items</div><div class="card-value">${inventory.length}</div><div class="card-sub">Unique SKUs in warehouse</div></div>
            `;
        }

        function openTx(type) {
            currentTxType = type;
            document.getElementById('txTitle').innerText = type === 'receive' ? 'Receive Goods (GR)' : 'Issue Goods (GI)';
            document.getElementById('lblRef').innerText = type === 'receive' ? 'PO Number / Reference' : 'Purpose / Cost Center';
            document.getElementById('thTxLoc').style.display = type === 'receive' ? '' : 'none';
            document.getElementById('txBody').innerHTML = '';
            document.getElementById('txRef').value = '';
            addTxRow();
            openModal('txModal');
        }

        function addTxRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="std-input tx-id" placeholder="ID" onchange="resolvePart(this)"></td>
                <td class="${currentTxType === 'receive' ? '' : 'display:none'}"><input type="text" class="std-input tx-loc"></td>
                <td><input type="number" class="std-input tx-qty" value="1"></td>
                <td><span style="color:red; cursor:pointer" onclick="this.parentElement.parentElement.remove()">‚úñ</span></td>
            `;
            document.getElementById('txBody').appendChild(tr);
        }

        function resolvePart(input) {
            const id = input.value.trim();
            const part = master.find(m => m.id === id);
            if(!part && id) {
                showMsg("Not Found", `Part ID "${id}" does not exist in Master Data.`);
                input.value = '';
            }
        }

        // ‰øÆÊîπÂæåÁöÑÊèê‰∫§ÈÇèËºØÔºöÂÖàË∑≥Á¢∫Ë™ç
        async function submitTx() {
            const lang = i18n[currentLang];
            document.getElementById('msgTitle').innerText = lang.confirm_post_title;
            document.getElementById('msgTitle').style.color = "var(--sap-primary)";
            document.getElementById('msgContent').innerText = lang.confirm_post_body;
            
            const okBtn = document.querySelector('#msgModal .btn-primary');
            okBtn.onclick = function() {
                closeModal('msgModal');
                executeSubmit();
            };
            openModal('msgModal');
        }

        async function executeSubmit() {
            const ref = document.getElementById('txRef').value;
            const user = document.getElementById('txUser').value;
            if(!ref || !user) { showToast("Reference & User Required", true); return; }
            
            const items = [];
            document.querySelectorAll('#txBody tr').forEach(row => {
                const idInput = row.querySelector('.tx-id');
                const qtyInput = row.querySelector('.tx-qty');
                const locInput = row.querySelector('.tx-loc');
                if(idInput && qtyInput) {
                    const id = String(idInput.value).trim();
                    const qty = Number(qtyInput.value);
                    const loc = locInput ? String(locInput.value).trim() : "";
                    if(id && qty > 0) items.push({ id, qty, loc });
                }
            });

            if(items.length === 0) { showToast("No items to post", true); return; }

            setLoading(true);
            try {
                await sendPost({ 
                    action: currentTxType === 'receive' ? 'bulk_receive' : 'bulk_issue', 
                    [currentTxType === 'receive' ? 'po' : 'purpose']: ref, 
                    user: user, 
                    items: items 
                });
                closeModal('txModal'); 
                fetchData(); 
                showToast("Transaction Posted!");
            } catch(e) { showMsg("Error", e.message); }
            finally { 
                setLoading(false); 
                document.querySelector('#msgModal .btn-primary').onclick = () => closeModal('msgModal');
            }
        }

        async function deleteMaster(id) {
            setLoading(true);
            try {
                const user = document.getElementById('txUser').value || "Admin";
                await sendPost({ action: 'delete_master', id: id, user: user });
                fetchData(); 
                showToast("Deleted!");
            } catch(e) { showMsg("Error", e.message); }
            finally { setLoading(false); }
        }

        async function createMaster() {
            const id = document.getElementById('newId').value.trim();
            if(!id) return;
            setLoading(true);
            try {
                const user = document.getElementById('txUser').value || "Admin";
                await sendPost({ 
                    action: 'create_master', id: id, 
                    model: document.getElementById('newModel').value,
                    description: document.getElementById('newDesc').value,
                    unit: document.getElementById('newUnit').value,
                    minStock: document.getElementById('newMinStock').value,
                    user: user
                });
                closeModal('createModal'); fetchData(); showToast("Created!");
            } catch(e) { showMsg("Error", e.message); }
            finally { setLoading(false); }
        }

        async function sendPost(data) {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            return new Promise(resolve => setTimeout(resolve, 1500));
        }

        function showDetails(id) {
            const item = inventory.find(i => i.id === id) || master.find(m => m.id === id);
            if(!item) return;
            document.getElementById('detailTitle').innerText = `Item Details: ${item.id}`;
            document.getElementById('detailInfo').innerHTML = `
                <div><b>Model:</b> ${item.model}</div>
                <div><b>Unit:</b> ${item.unit}</div>
                <div><b>Desc:</b> ${item.description}</div>
                <div><b>Current Stock:</b> ${item.stock || 0}</div>
            `;
            const histBody = document.getElementById('detailHistory');
            histBody.innerHTML = '';
            history.filter(h => h.id === id).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(h => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(h.date).toLocaleString()}</td>
                    <td>${h.ref}</td>
                    <td>${h.type}</td>
                    <td style="text-align:right">${h.qty}</td>
                    <td>${h.user}</td>
                `;
                histBody.appendChild(tr);
            });
            openModal('detailModal');
        }

        function showTab(tab, el) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('view-inv').style.display = tab === 'inv' ? 'block' : 'none';
            document.getElementById('view-master').style.display = tab === 'master' ? 'block' : 'none';
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(i18n[currentLang][key]) el.innerText = i18n[currentLang][key];
            });
            renderTable(); renderDashboard(); renderMasterTable();
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function setLoading(b) { document.getElementById('loading').style.display = b?'block':'none'; }
        function showMsg(title, content) {
            document.getElementById('msgTitle').innerText = title;
            document.getElementById('msgTitle').style.color = "var(--sap-critical)";
            document.getElementById('msgContent').innerText = content;
            openModal('msgModal');
        }
        function showToast(msg, err) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.background = err ? "#bb0000" : "#32363a";
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(inventory);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventory");
            XLSX.writeFile(wb, "Inventory_Export.xlsx");
        }

        window.onload = fetchData;
    </script>
</body>
</html>
