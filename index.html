<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WMS</title>
    
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/354a5f/ffffff.png?text=WMS&font=roboto">
    <link rel="icon" href="https://placehold.co/192x192/354a5f/ffffff.png?text=WMS&font=roboto">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- SAP Fiori Style Theme --- */
        :root {
            --sap-shell-color: #354a5f; --sap-bg-color: #edf0f4; --sap-surface-color: #ffffff;
            --sap-text-color: #32363a; --sap-border-color: #d9d9d9;
            --sap-primary: #0a6ed1; --sap-success: #107e3e; --sap-critical: #bb0000; --sap-warning: #e9730c;
            --sap-font-family: "72", "Arial", "Helvetica", sans-serif;
        }
        body { margin: 0; padding: 0; font-family: var(--sap-font-family); background-color: var(--sap-bg-color); color: var(--sap-text-color); font-size: 0.875rem; line-height: 1.4; }
        
        .shell-bar { background-color: var(--sap-shell-color); height: 44px; display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; color: white; box-shadow: 0 4px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .shell-logo { font-weight: bold; font-size: 1rem; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;}
        
        .page-header { background-color: var(--sap-surface-color); padding: 1rem 2rem; border-bottom: 1px solid var(--sap-border-color); display: flex; justify-content: space-between; align-items: center; }
        .content-area { padding: 1rem 2rem; max-width: 100%; box-sizing: border-box; }
        
        .nav-tabs { display: flex; gap: 20px; }
        .nav-item { cursor: pointer; padding-bottom: 5px; color: #6a6d70; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .nav-item:hover { color: var(--sap-primary); }
        .nav-item.active { color: var(--sap-primary); border-bottom-color: var(--sap-primary); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--sap-border-color); }
        .card-title { font-size: 13px; color: #666; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; }
        .card-value { font-size: 36px; font-weight: normal; color: var(--sap-text-color); }
        .card-sub { font-size: 12px; color: #888; margin-top: 5px; }
        .card.alert { border-left: 5px solid var(--sap-critical); }
        .card.warn { border-left: 5px solid var(--sap-warning); }
        .card.safe { border-left: 5px solid var(--sap-success); }

        .table-container { background: var(--sap-surface-color); border: 1px solid var(--sap-border-color); border-radius: 4px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-top: 1rem; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; table-layout: fixed; min-width: 1000px; }
        thead { background-color: #f7f7f7; border-bottom: 1px solid var(--sap-border-color); }
        th { padding: 10px 16px; font-weight: normal; color: #6a6d70; font-size: 12px; text-transform: uppercase; }
        td { padding: 10px 16px; border-bottom: 1px solid #eeeeee; vertical-align: middle; color: var(--sap-text-color); }
        tr:hover { background-color: #ebf5fe; cursor: pointer; }

        .col-status { width: 35px; text-align: center; padding: 0 !important; }
        .col-pn { width: 120px; font-weight: bold; color: var(--sap-primary); }
        th.col-pn, td.col-pn { padding-left: 12px !important; }
        .col-model { width: 350px; white-space: normal; word-wrap: break-word; line-height: 1.3; } /* Model Ê¨Ñ‰ΩçÂä†ÂØ¨ */
        .col-desc { width: auto; white-space: normal; word-wrap: break-word; line-height: 1.3; } 
        .col-loc { width: 80px; text-align: center; font-weight: bold; color: #555; }
        .col-stock { width: 90px; text-align: right; }
        .col-unit { width: 60px; }
        .col-action { width: 120px; text-align: center; white-space: nowrap;}
        .col-loc span { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 11px; }

        .toolbar { padding: 10px 0; display: flex; gap: 10px; align-items: center; flex-wrap: nowrap; width: 100%; }
        .spacer { flex-grow: 1; }

        .std-input { height: 36px; padding: 0 10px; border: 1px solid #89919a; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; background-color: white; font-family: var(--sap-font-family); transition: border-color 0.2s; }
        .std-input:focus { outline: none; border-color: var(--sap-primary); box-shadow: 0 0 0 1px var(--sap-primary) inset; }
        .std-input:disabled, .std-input:read-only { background-color: #f5f5f5; border-color: #d9d9d9; color: #666; cursor: default; }
        
        .std-btn { height: 36px; padding: 0 16px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 13px; font-family: var(--sap-font-family); display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.1s; border: 1px solid transparent; white-space: nowrap; }
        
        .btn-po { background-color: var(--sap-primary); color: white; border-color: var(--sap-primary); }
        .btn-issue { background-color: var(--sap-critical); color: white; border-color: var(--sap-critical); } .btn-issue:hover { opacity: 0.9; }
        .btn-master { background-color: transparent; color: var(--sap-primary); border: 1px solid var(--sap-primary); }
        .btn-primary { background-color: var(--sap-primary); color: white; }
        .btn-transparent { background: transparent; color: var(--sap-primary); }
        .btn-excel { background-color: #107e3e; color: white; border-color: #107e3e; } .btn-excel:hover { opacity: 0.9; }

        .btn-delete { color: #bb0000; font-weight: bold; cursor: pointer; padding: 4px 8px; border-radius: 4px; border: 1px solid transparent; margin-left: 5px; font-size: 12px; }
        .btn-delete:hover { background-color: #ffe6e6; border-color: #bb0000; }

        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; vertical-align: middle; }
        .status-ok { background-color: var(--sap-success); } .status-low { background-color: var(--sap-warning); } .status-crit { background-color: var(--sap-critical); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .std-dialog { background: white; width: 500px; border-radius: 6px; display: flex; flex-direction: column; animation: fadeIn 0.2s; max-height: 90vh; box-shadow: 0 0 20px rgba(0,0,0,0.15); border: 1px solid var(--sap-border-color); }
        .std-dialog.large { width: 950px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dialog-header { padding: 10px 20px; border-bottom: 1px solid var(--sap-border-color); display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: bold; color: var(--sap-text-color); background: var(--sap-surface-color); }
        .dialog-content { padding: 20px; overflow-y: auto; background: var(--sap-surface-color); }
        .dialog-footer { padding: 10px 20px; border-top: 1px solid var(--sap-border-color); display: flex; justify-content: flex-end; gap: 10px; background: #fdfdfd; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-full { grid-column: span 2; }
        .form-label { display: block; font-size: 12px; color: #6a6d70; margin-bottom: 4px; }
        .tx-table { width: 100%; border: 1px solid var(--sap-border-color); border-radius: 4px; border-collapse: separate; border-spacing: 0; margin-bottom: 10px;}
        .tx-table th { background: #f2f2f2; padding: 10px; font-size: 11px; border-bottom: 1px solid var(--sap-border-color); text-transform: uppercase; color: #666; font-weight: bold; }
        .tx-table td { padding: 6px 8px; border-bottom: 1px solid var(--sap-border-color); background: #fff; vertical-align: top; }
        .tx-input { width: 100%; padding: 6px 8px; border: 1px solid #89919a; border-radius: 4px; background: #fff; font-family: inherit; font-size: 13px; box-sizing: border-box; transition: border-color 0.2s; }
        .tx-input:focus { outline: none; border-color: var(--sap-primary); box-shadow: 0 0 0 1px var(--sap-primary) inset; }
        .tx-input[readonly] { background-color: #f5f5f5; border-color: #d9d9d9; color: #666; cursor: default; }
        
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--sap-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #32363a; color: white; padding: 10px 20px; border-radius: 4px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 3000; font-size: 13px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        .tx-row { border: 1px solid #eee; padding: 10px; border-radius: 4px; margin-bottom: 10px; position: relative; background: #fafafa; }
        .tx-remove { position: absolute; top: 5px; right: 5px; color: #bb0000; font-size: 20px; font-weight: bold; cursor: pointer; }

        @media (max-width: 992px) { 
            .page-header { padding: 10px 15px; flex-direction: row; align-items: center; }
            .nav-tabs { gap: 15px; overflow-x: auto; padding-bottom: 0; }
            .nav-item { font-size: 14px; }
            .toolbar { flex-wrap: wrap; gap: 8px; }
            .std-btn { flex: 1 1 auto; justify-content: center; } 
            .spacer { display: none; }
            .toolbar input { width: 100% !important; order: 99; margin-top: 5px; }
            .desktop-only { display: table-cell !important; }
            .std-dialog, .std-dialog.large { width: 95% !important; max-height: 85vh; }
            .dialog-header-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
            .tx-table { display: block; overflow-x: auto; white-space: nowrap; }
        }
    </style>
</head>
<body>

<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--sap-bg-color); z-index:9999; display:flex; justify-content:center; align-items:center;">
    <div class="std-dialog" style="width:320px; padding:20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
        <div style="text-align:center; margin-bottom:20px;">
            <h2 style="color:var(--sap-shell-color); margin:0;">Sunlit AZ WMS</h2>
            <p style="font-size:12px; color:#666; margin-top:5px;">Please sign in to continue</p>
        </div>
        <div style="display:grid; gap:15px;">
            <input type="text" id="loginUser" class="std-input" placeholder="Username" style="width:100%;" oninput="clearLoginError()">
            <input type="password" id="loginPass" class="std-input" placeholder="Password" style="width:100%;" oninput="clearLoginError()">
            <div id="loginFeedback" style="color:#bb0000; font-size:13px; text-align:center; min-height:18px; font-weight:bold;"></div>
            <button class="std-btn btn-primary" style="width:100%; justify-content:center; height:40px;" onclick="doLogin()">Sign In</button>
        </div>
    </div>
</div>

<div class="shell-bar">
    <div class="shell-logo">
        <span style="font-weight:bold; font-size:1.2em;">Sunlit AZ</span> WMS
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
        <div style="cursor:pointer; font-size:12px; opacity:0.9;" onclick="toggleLanguage()">EN / ÁπÅ‰∏≠</div>
        <div id="logoutBtn" style="cursor:pointer; font-size:12px; opacity:0.9; display:none;" onclick="doLogout()">Logout ‚èª</div>
    </div>
</div>

<div class="page-header">
    <div>
        <div class="nav-tabs">
            <div class="nav-item active" id="tabDash" onclick="switchView('dashboard')" data-i18n="tab_dash">Dashboard</div>
            <div class="nav-item" id="tabInv" onclick="switchView('inventory')" data-i18n="tab_inv">Inventory</div>
            <div class="nav-item" id="tabMaster" onclick="switchView('master')" data-i18n="tab_master">Master Data</div>
        </div>
        <div style="color:#6a6d70; font-size:12px; margin-top:8px;">Sunlit AZ / Spare Part Management</div>
    </div>
    <button class="std-btn btn-transparent" onclick="fetchData()">
        <span style="font-size:16px;">‚Üª</span> <span data-i18n="btn_refresh">Refresh</span>
    </button>
</div>

<div class="content-area">
    <div id="viewDashboard">
        <div class="dashboard-grid">
            <div class="card alert">
                <div class="card-title" data-i18n="card_crit">Critical Stock</div>
                <div class="card-value" id="dashCrit" style="color:#bb0000">0</div>
                <div class="card-sub" data-i18n="sub_crit">Items Out of Stock</div>
            </div>
            <div class="card warn">
                <div class="card-title" data-i18n="card_low">Low Stock</div>
                <div class="card-value" id="dashLow" style="color:#e9730c">0</div>
                <div class="card-sub" data-i18n="sub_low">Items below safety level</div>
            </div>
            <div class="card safe">
                <div class="card-title" data-i18n="card_total">Total Items</div>
                <div class="card-value" id="dashTotal">0</div>
                <div class="card-sub" data-i18n="sub_total">Active SKU Count</div>
            </div>
            <div class="card">
                <div class="card-title" data-i18n="card_hist">Recent Movements</div>
                <div style="font-size:12px; color:#555; max-height:100px; overflow-y:auto;" id="dashHistory"></div>
            </div>
        </div>
    </div>

    <div id="viewInventory" style="display:none;">
        <div class="toolbar">
            <button class="std-btn btn-po" onclick="openTxModal('receive')"><span data-i18n="btn_po">Goods Receipt</span></button>
            <button class="std-btn btn-issue" onclick="openTxModal('issue')"><span data-i18n="btn_issue">Goods Issue</span></button>
            <button class="std-btn btn-excel" onclick="exportToExcel('inventory')">üì• Excel</button>
            <div class="spacer"></div>
            <input type="text" id="searchInv" class="std-input" style="width:250px;" placeholder="Search Inventory..." onkeyup="renderTable()">
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th data-i18n="th_id">ID</th>
                        <th data-i18n="th_model" class="col-model">Model</th>
                        <th data-i18n="th_stock">Stock</th>
                        <th data-i18n="th_unit">Unit</th>
                        <th data-i18n="th_loc">Location</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>
    </div>

    <div id="txModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="txTitle">Transaction</h3>
                <span style="cursor:pointer; font-size:24px;" onclick="closeModal('txModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div>
                        <label data-i18n="lbl_ref">Ref (PO/Purpose)</label>
                        <input type="text" id="txRef" class="std-input">
                    </div>
                    <div>
                        <label data-i18n="lbl_date">Date</label>
                        <input type="date" id="txDate" class="std-input">
                    </div>
                    <div>
                        <label data-i18n="lbl_user">User</label>
                        <input type="text" id="txUser" class="std-input" readonly>
                    </div>
                    <div>
                        <label data-i18n="lbl_loc">Update Location</label>
                        <input type="text" id="txLoc" class="std-input" placeholder="Optional">
                    </div>
                </div>
                <div id="txBody"></div>
                <button class="std-btn" style="width:100%; justify-content:center; margin-top:10px;" onclick="addTxRow()">‚ûï Add Item</button>
            </div>
            <div class="modal-footer">
                <button class="std-btn" onclick="closeModal('txModal')" data-i18n="btn_cancel">Cancel</button>
                <button class="std-btn btn-primary" onclick="submitTx()" data-i18n="btn_submit">Post Transaction</button>
            </div>
        </div>
    </div>

    <div id="masterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="btn_master">Master Data</h3>
                <span style="cursor:pointer; font-size:24px;" onclick="closeModal('masterModal')">&times;</span>
            </div>
            <div class="modal-body">
                <button class="std-btn btn-primary" onclick="openModal('createModal')" style="margin-bottom:10px;">‚ûï Create New Master</button>
                <input type="text" id="searchMaster" class="std-input" style="width:100%; margin-bottom:10px;" placeholder="Search Master Data..." onkeyup="renderMasterTable()">
                <div style="overflow-x:auto;">
                    <table style="min-width: 100%;">
                        <thead>
                            <tr>
                                <th data-i18n="th_id">ID</th>
                                <th data-i18n="th_model">Model</th>
                                <th data-i18n="th_min">Min</th>
                                <th data-i18n="th_action">Action</th>
                            </tr>
                        </thead>
                        <tbody id="masterTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="createModal" class="modal" style="z-index: 1100;">
        <div class="modal-content" style="max-height: 80vh;">
            <div class="modal-header"><h3>Create Master</h3></div>
            <div class="modal-body">
                <div style="display:grid; gap:10px;">
                    <input type="text" id="newId" class="std-input" placeholder="ID">
                    <input type="text" id="newModel" class="std-input" placeholder="Model Name">
                    <input type="text" id="newDesc" class="std-input" placeholder="Description">
                    <input type="text" id="newUnit" class="std-input" placeholder="Unit (e.g. EA, SET)">
                    <input type="number" id="newMinStock" class="std-input" placeholder="Min Stock Level">
                    <input type="text" id="newUser" class="std-input" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button class="std-btn" onclick="closeModal('createModal')">Cancel</button>
                <button class="std-btn btn-primary" onclick="submitCreateMaster()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è Ë´ãÂ°´ÂÖ•ÊÇ®ÁöÑ Google Apps Script ÈÉ®ÁΩ≤Á∂≤ÂùÄ (ÂãôÂøÖ‰ΩøÁî®Êñ∞ÁâàÁ∂≤ÂùÄ)
        const API_URL = "https://script.google.com/macros/s/AKfycbwj57eCE8dveffooXWT1vnrA-2Zf2irtRrkOGjJHp-ZaoRRul-c-qX2a5eJ5hetP1Pa4Q/exec"; 

        let inventory = [];
        let master = [];
        let currentLang = 'en';
        let currentTxType = 'receive';
        let currentUserDisplayName = "";

        const i18n = {
            en: {
                stat_items: "Active Items", stat_low: "Low Stock", btn_po: "Goods Receipt", btn_issue: "Goods Issue",
                btn_master: "Master Data", btn_export: "Export", btn_refresh: "Refresh",
                th_id: "ID", th_model: "Model", th_stock: "Stock", th_unit: "Unit", th_loc: "Location", th_min: "Min", th_action: "Action",
                lbl_ref: "Reference (PO/Job)", lbl_date: "Post Date", lbl_user: "User", lbl_loc: "Update Location", lbl_qty: "Qty",
                btn_cancel: "Cancel", btn_submit: "Post Transaction",
                msg_input_required: "Input Required",
                msg_missing_ref: "Field 'Reference' is empty.",
                msg_missing_loc: "Field 'Update Location' is empty.",
                error_title: "Insufficient Stock",
                error_msg: "Cannot issue more than available stock.",
                col_pn: "Part Number",
                deleted: "Deleted!"
            },
            zh: {
                stat_items: "ÂìÅÈ†ÖÁ∏ΩÊï∏", stat_low: "‰ΩéÂ∫´Â≠òË≠¶Á§∫", btn_po: "Êî∂Ë≤®ÂÖ•Â∫´", btn_issue: "È†òÊñôÂá∫Â∫´",
                btn_master: "‰∏ªÊ™îÁÆ°ÁêÜ", btn_export: "Â∞éÂá∫ Excel", btn_refresh: "Âà∑Êñ∞",
                th_id: "Á∑®Ëôü", th_model: "Ë¶èÊ†ºÂûãËôü", th_stock: "Â∫´Â≠òÈáè", th_unit: "ÂñÆ‰Ωç", th_loc: "ÂÑ≤‰Ωç", th_min: "ÂÆâÂÖ®Â∫´Â≠ò", th_action: "Êìç‰Ωú",
                lbl_ref: "ÂèÉËÄÉÂñÆËôü", lbl_date: "ÈÅéÂ∏≥Êó•Êúü", lbl_user: "Êìç‰Ωú‰∫∫Âì°", lbl_loc: "Êõ¥Êñ∞ÂÑ≤‰Ωç", lbl_qty: "Êï∏Èáè",
                btn_cancel: "ÂèñÊ∂à", btn_submit: "Á¢∫Ë™çÈÅéÂ∏≥",
                msg_input_required: "Ê¨Ñ‰ΩçÂøÖÂ°´",
                msg_missing_ref: "Ê¨Ñ‰Ωç [ÂèÉËÄÉÂñÆËôü] Â∞öÊú™Â°´ÂØ´„ÄÇ",
                msg_missing_loc: "Ê¨Ñ‰Ωç [Êõ¥Êñ∞ÂÑ≤‰Ωç] Â∞öÊú™Â°´ÂØ´„ÄÇ",
                error_title: "Â∫´Â≠ò‰∏çË∂≥",
                error_msg: "È†òÊñôÊï∏Èáè‰∏çÂèØÂ§ßÊñºÁèæÊúâÂ∫´Â≠ò„ÄÇ",
                col_pn: "ÊñôËôü",
                deleted: "Â∑≤Âà™Èô§ÔºÅ"
            }
        };

        // --- Auth Logic ---
        async function doLogin() {
            const user = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value.trim();
            const feedback = document.getElementById('loginFeedback');
            feedback.innerText = "";

            if(!user || !pass) {
                feedback.innerText = "Please enter username and password";
                return;
            }

            setLoading(true);
            try {
                const res = await sendPost({ action: 'login', username: user, password: pass });
                if(res.status === 'success') {
                    const displayName = res.message.name;
                    localStorage.setItem('wms_user', displayName);
                    applyLoginState(displayName);
                } else {
                    feedback.innerText = res.message || "Invalid Credentials";
                    document.querySelector('#loginOverlay .std-dialog').animate([
                        { transform: 'translateX(0)' }, { transform: 'translateX(-10px)' }, { transform: 'translateX(10px)' }, { transform: 'translateX(0)' }
                    ], { duration: 300 });
                }
            } catch(e) {
                feedback.innerText = "Connection Error. Please check Internet.";
            } finally {
                setLoading(false);
            }
        }

        function clearLoginError() { document.getElementById('loginFeedback').innerText = ""; }

        function applyLoginState(name) {
            currentUserDisplayName = name;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            showToast("Welcome, " + currentUserDisplayName);
            fetchData(); 
        }

        function doLogout() { localStorage.removeItem('wms_user'); location.reload(); }

        function checkAutoLogin() {
            const savedUser = localStorage.getItem('wms_user');
            if (savedUser) applyLoginState(savedUser);
        }

        async function sendPost(data) {
            const realResponse = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
            return await realResponse.json();
        }

        async function fetchData() {
            if(API_URL.includes("YOUR_GOOGLE")) { alert("Setup API URL first!"); return; }
            setLoading(true);
            try {
                const res = await sendPost({ action: 'get_data' });
                if(res.status === 'success') {
                    inventory = res.message.inventory;
                    // Fix: Ensure master is always an object array or convert if backend sends map
                    // Backend sends { inventory: [], master: {}, history: [] }
                    // We need master as array for table, and map for lookups
                    const masterMap = res.message.master;
                    master = Object.keys(masterMap).map(k => ({ id: k, ...masterMap[k] }));
                    
                    renderTable();
                    renderDashboard();
                    renderMasterTable();
                } else {
                    alert(res.message);
                }
            } catch(e) { console.error(e); alert("Network Error"); }
            finally { setLoading(false); }
        }

        function renderDashboard() {
            document.getElementById('statItems').innerText = inventory.length;
            const low = inventory.filter(i => i.stock <= i.minStock).length;
            document.getElementById('statLow').innerText = low;
        }

        function renderTable() {
            const term = document.getElementById('searchInv').value.toLowerCase();
            const body = document.getElementById('inventoryBody');
            body.innerHTML = inventory.filter(i => (i.id+i.model).toLowerCase().includes(term)).map(item => `
                <tr>
                    <td>${item.id}</td>
                    <td><b>${item.model}</b><br><small>${item.description}</small></td>
                    <td class="${item.stock <= item.minStock ? 'stock-low' : ''}">${item.stock}</td>
                    <td>${item.unit}</td>
                    <td>${item.location || '-'}</td>
                </tr>
            `).join('');
        }

        function renderMasterTable() {
            const term = document.getElementById('searchMaster').value.toLowerCase();
            const body = document.getElementById('masterTableBody');
            body.innerHTML = master.filter(m => (m.id+m.model).toLowerCase().includes(term)).map(m => `
                <tr>
                    <td>${m.id}</td>
                    <td>${m.model}</td>
                    <td>${m.minStock}</td>
                    <td><button class="btn-delete" onclick="deleteMaster('${m.id}')">‚úï</button></td>
                </tr>
            `).join('');
        }

        async function deleteMaster(id) {
            // Check stock first
            const invItem = inventory.find(i => i.id === id);
            const stock = invItem ? invItem.stock : 0;
            const lang = i18n[currentLang];

            if (stock > 0) {
                alert(currentLang === 'en' ? `Cannot delete ${id}. Stock is ${stock}.` : `ÁÑ°Ê≥ïÂà™Èô§ ${id}ÔºåÂ∞öÊúâÂ∫´Â≠ò ${stock}„ÄÇ`);
                return;
            }

            if(!confirm(currentLang === 'en' ? `Delete Master ID: ${id}?` : `Á¢∫ÂÆöÂà™Èô§ÊñôËôü: ${id}?`)) return;
            
            setLoading(true);
            try {
                await sendPost({ action: 'delete_master', id: id, user: currentUserDisplayName });
                fetchData();
                showToast(lang.deleted);
            } catch(e) { alert(e.message); }
            finally { setLoading(false); }
        }

        function openTxModal(type) {
            currentTxType = type;
            const isReceive = type === 'receive';
            const lang = i18n[currentLang];
            document.getElementById('txTitle').innerText = isReceive ? lang.btn_po : lang.btn_issue;
            document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
            
            // Auto fill user
            document.getElementById('txUser').value = currentUserDisplayName;
            document.getElementById('txUser').readOnly = true;

            document.getElementById('txRef').value = "";
            
            // Toggle Location Visibility based on type
            const locInput = document.getElementById('txLoc');
            locInput.style.display = isReceive ? 'block' : 'none';
            locInput.previousElementSibling.style.display = isReceive ? 'block' : 'none'; // Hide label too
            if (isReceive) locInput.value = ""; 

            document.getElementById('txBody').innerHTML = "";
            addTxRow(); 
            openModal('txModal');
        }

        function addTxRow() {
            const div = document.createElement('div');
            div.className = 'tx-row';
            div.innerHTML = `
                <span class="tx-remove" onclick="this.parentElement.remove()">‚úï</span>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                    <select class="std-input tx-id-select">
                        <option value="">-- Select Item --</option>
                        ${master.map(m => `<option value="${m.id}">${m.id} | ${m.model}</option>`).join('')}
                    </select>
                    <input type="number" class="std-input tx-qty" placeholder="Qty">
                </div>
            `;
            document.getElementById('txBody').appendChild(div);
        }

        // üî• Updated Submit Function with Validation
        async function submitTx() {
            const lang = i18n[currentLang];
            
            // 1. Check Reference
            const refVal = document.getElementById('txRef').value.trim();
            if(!refVal) {
                alert(lang.msg_missing_ref);
                return;
            }

            // 2. Check Header Location (Only for Receive)
            const locVal = document.getElementById('txLoc').value.trim();
            // If you want Location mandatory for Receive:
            if(currentTxType === 'receive' && !locVal) {
                alert(lang.msg_missing_loc);
                return;
            }

            const items = [];
            const rows = document.querySelectorAll('.tx-row');
            if(rows.length === 0) return;

            let hasError = false;

            // 3. Check Rows
            for(let i=0; i<rows.length; i++) {
                const id = rows[i].querySelector('.tx-id-select').value;
                const qty = rows[i].querySelector('.tx-qty').value;

                if(!id) {
                    alert(lang.msg_input_required + ": " + lang.col_pn);
                    hasError = true; break;
                }
                if(!qty || Number(qty) <= 0) {
                    alert(lang.msg_input_required + ": " + lang.lbl_qty);
                    hasError = true; break;
                }

                // 4. Check Stock for Issue
                if (currentTxType === 'issue') {
                    const invItem = inventory.find(x => x.id === id);
                    const currentStock = invItem ? invItem.stock : 0;
                    if (Number(qty) > currentStock) {
                        alert(`${lang.error_title}: ${id}\n${lang.error_msg}`);
                        hasError = true; break;
                    }
                }

                items.push({ id, qty: Number(qty) });
            }

            if(hasError) return;

            setLoading(true);
            try {
                const action = currentTxType === 'receive' ? 'bulk_receive' : 'bulk_issue';
                const payload = {
                    action: action,
                    po: refVal,
                    location: locVal,
                    user: currentUserDisplayName,
                    items: items
                };
                const res = await sendPost(payload);
                if(res.status === 'success') {
                    closeModal('txModal'); fetchData(); showToast("Success!");
                } else { alert(res.message); }
            } catch(e) { alert("Error: " + e.message); }
            finally { setLoading(false); }
        }

        async function submitCreateMaster() {
            const id = document.getElementById('newId').value.trim();
            if(!id) return;
            setLoading(true);
            try {
                await sendPost({
                    action: 'create_master', id: id, 
                    model: document.getElementById('newModel').value,
                    description: document.getElementById('newDesc').value,
                    unit: document.getElementById('newUnit').value,
                    minStock: document.getElementById('newMinStock').value,
                    user: currentUserDisplayName
                });
                closeModal('createModal'); fetchData(); showToast("Created!");
            } catch(e) { alert(e.message); }
            finally { setLoading(false); }
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(i18n[currentLang][key]) el.innerText = i18n[currentLang][key];
            });
            renderTable(); renderDashboard(); renderMasterTable();
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function setLoading(b) { document.getElementById('loading').style.display = b?'block':'none'; }
        function showToast(msg, err) { const t = document.getElementById('toast'); t.innerText = msg; t.style.background = err ? "#bb0000" : "#32363a"; t.style.opacity = 1; setTimeout(()=>t.style.opacity=0, 2000); }

        checkAutoLogin();
    </script>
</body>
</html>
